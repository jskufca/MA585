---
title: "Stan analysis of ABC1 Testing results using Heirarchical model"
author: "Joe Skufca"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

I will use the stan code from the Stan User's Guide.



### Packages

I load a standard kid of packages, in case we need it.

```{r}
library(knitr)
library(broom)
library(gridExtra)
library(readxl)
library(tidyverse) # data manipulation and visualization - loads several packages
library(janitor)
```
And I also load `rstan` an R wrapper that makes it easy to use STAN inside of R.



```{r}
library ("rstan")
rstan_options(auto_write = TRUE)
```


### Load a dataset

From 2018, data is test scores for first 4 exams, filtered so that we are looking only at students who took all four exams (to simplify our structure).

```{r}
df1=read_excel("MA131_ABC_EXAM_Fall_2018_final DL.xls",col_names = F) %>%
  rename_with(~paste0("t",.x))%>% clean_names() %>% 
  mutate(ID=factor(1:139))

df2=df1 %>% pivot_longer(1:4) %>% select(-name) %>% mutate(t=rep(c(0,1,2,3),139))

df2 %>% group_by(ID) %>%  ggplot(aes(x=t,y=value,group=ID)) +geom_line()

```


# Below not fixed

### Run the stan using a chaing


```{r}
reg_fit=stan(file = "regression1.stan",
                 data=c("N","x","y"), iter=1000,chains = 4)
print(reg_fit)
plot(reg_fit)

```


```{r}
plot(reg_fit,plotfun="rhat",ncol=1)
```

```{r}
lm(dist~speed,data=df1) %>% summary()
```

## A second example - a learning problem

Suppose we "learn" a task (over time), with $p$ giving the probability that we can demonstrate a particular knowledge element.

### Data creation

```{r}
A=.95
B=.15

N = 20
t=1:N # data

p=A*(1-exp(-B*t)) # unknown 

y=rbinom(20,10,p) # data

```


```{r}
reg_fit=stan(file = "regression2.stan",
                 data=c("N","t","y"), iter=1000,chains = 4)
print(reg_fit)
plot(reg_fit)

```



